<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ordina - Scuola Borsa</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
:root { --red:#e63946; --dark:#080404; }
body {
  font-family:'Montserrat',sans-serif;
  background:
    radial-gradient(ellipse at 20% 40%, rgba(110,30,30,0.3) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 70%, rgba(70,15,15,0.25) 0%, transparent 50%),
    linear-gradient(135deg, #0a0404 0%, #120505 50%, #0d0404 100%);
  min-height:100vh;
  color:white;
  overflow-x:hidden;
}
body::before {
  content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,0.025) 1px, transparent 0);
  background-size:28px 28px;
}

/* ===== NAVBAR ===== */
.navbar {
  display:flex; align-items:center; justify-content:center; gap:50px;
  padding:0 50px;
  background:linear-gradient(180deg,rgba(6,6,6,0.98),rgba(10,3,3,0.95));
  backdrop-filter:blur(24px);
  border-bottom:1px solid rgba(230,57,70,0.15);
  box-shadow:0 8px 40px rgba(0,0,0,0.7);
  position:fixed; width:100%; top:0; height:90px; z-index:100;
}
.navbar::before {
  content:""; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,transparent,#e63946 25%,#ff8080 50%,#e63946 75%,transparent);
  opacity:0.7;
}
.logo-left { position:absolute; left:50px; display:flex; align-items:center; gap:12px; }
.logo-left img { width:62px; height:62px; object-fit:contain; filter:drop-shadow(0 0 8px rgba(230,57,70,0.3)); }
.logo-left-divider { width:1px; height:30px; background:rgba(255,255,255,0.15); }
.logo-brand { display:flex; flex-direction:column; line-height:1.15; }
.logo-brand .brand-sub { font-size:10px; font-weight:400; letter-spacing:3.5px; text-transform:uppercase; color:rgba(255,255,255,0.35); }
.logo-brand .brand-main { font-size:14px; font-weight:800; letter-spacing:2.5px; text-transform:uppercase; color:white; }
.nav-center ul { display:flex; gap:2px; list-style:none; }
.nav-center a { color:rgba(255,255,255,0.55); font-weight:600; text-decoration:none; font-size:12px; letter-spacing:2px; text-transform:uppercase; transition:all 0.25s ease; cursor:pointer; padding:9px 16px; border-radius:7px; display:block; }
.nav-center a:hover { color:white; background:rgba(255,255,255,0.07); }
.nav-center li:last-child a { color:#ff6b6b; border:1px solid rgba(230,57,70,0.35); background:rgba(230,57,70,0.08); padding:8px 18px; border-radius:20px; }
.nav-center li:last-child a:hover { background:rgba(230,57,70,0.2); border-color:rgba(230,57,70,0.6); color:white; }
.social-icons { position:absolute; right:50px; display:flex; gap:8px; }
.social-icons a { width:34px; height:34px; border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); display:flex; justify-content:center; align-items:center; border-radius:8px; color:rgba(255,255,255,0.5); font-size:14px; transition:all 0.25s ease; text-decoration:none; }
.social-icons a:hover { background:rgba(230,57,70,0.15); border-color:rgba(230,57,70,0.45); color:#ff8080; transform:translateY(-2px); }
.menu-toggle { display:none; position:absolute; right:20px; top:50%; transform:translateY(-50%); background:transparent; border:none; color:white; font-size:24px; cursor:pointer; z-index:11; }

/* ===== PAGE LAYOUT ===== */
.page-wrapper {
  position:relative; z-index:1;
  padding:120px 20px 80px;
  display:flex; flex-direction:column; align-items:center; min-height:100vh;
}

.page-header { text-align:center; margin-bottom:40px; }
.page-header h1 { font-size:42px; font-weight:800; font-style:italic; font-family:'Georgia',serif; color:white; line-height:1; letter-spacing:1px; }
.page-header .accent-line { width:52px; height:3px; background:var(--red); border-radius:2px; margin:14px auto 0; }

/* ===== MAIN CARD ===== */
.main-card {
  width:100%; max-width:580px;
  background:rgba(20,8,8,0.85);
  backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;
  box-shadow:0 12px 50px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.06);
  padding:32px;
  margin-bottom:0;
}

/* Section labels */
.section-label {
  font-size:10px; font-weight:800; letter-spacing:4px;
  text-transform:uppercase; color:rgba(230,57,70,0.8);
  margin-bottom:14px; display:block;
}

.red-divider { height:1px; background:linear-gradient(90deg,rgba(230,57,70,0.5),transparent); margin-bottom:20px; }

/* ===== PRODUCTS HEADER ===== */
.products-header {
  display:grid; grid-template-columns:1fr 100px 70px;
  gap:14px; padding:0 4px; margin-bottom:12px;
}
.products-header span { font-size:10px; font-weight:800; letter-spacing:3px; text-transform:uppercase; color:rgba(255,255,255,0.3); }
.products-header .h-qty { text-align:center; }
.products-header .h-price { text-align:right; }

/* ===== PRODUCT CONTAINER ===== */
#product-container { display:flex; flex-direction:column; gap:10px; max-height:320px; overflow-y:auto; padding-right:4px; }
#product-container::-webkit-scrollbar { width:5px; }
#product-container::-webkit-scrollbar-track { background:rgba(255,255,255,0.04); border-radius:10px; }
#product-container::-webkit-scrollbar-thumb { background:rgba(230,57,70,0.4); border-radius:10px; }

/* ===== PRODUCT CARD ===== */
.product-card {
  display:grid; grid-template-columns:1fr 100px 70px;
  align-items:center; gap:14px;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:14px; padding:14px 16px;
  transition:all 0.25s ease;
  box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
}
.product-card:hover { background:rgba(255,255,255,0.09); border-color:rgba(255,255,255,0.18); }

.product-name { display:flex; align-items:center; gap:10px; min-width:0; }

.product-name span {
  font-size:15px; font-weight:700;
  color:white;            /* BIANCO PIENO — leggibile */
  line-height:1.4;
  word-break:break-word;
}

/* NOTE BTN */
.note-btn {
  width:32px; height:32px; min-width:32px;
  border-radius:8px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14);
  display:flex; justify-content:center; align-items:center;
  cursor:pointer; transition:all 0.2s ease; flex-shrink:0;
}
.note-btn:hover { background:rgba(230,57,70,0.18); border-color:rgba(230,57,70,0.4); }
.note-btn svg { stroke:rgba(255,255,255,0.65); }
.note-btn:hover svg { stroke:#ff9090; }

/* QTY */
.qty-column { display:flex; justify-content:center; }
.qty-box { display:flex; align-items:center; gap:8px; }
.qty-btn {
  width:28px; height:28px;
  background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.18);
  border-radius:7px; color:white; font-size:17px; font-weight:700;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:all 0.2s ease; line-height:1;
}
.qty-btn:hover { background:rgba(230,57,70,0.25); border-color:rgba(230,57,70,0.55); }
.qty {
  font-size:16px; font-weight:800; min-width:22px;
  text-align:center; color:white;   /* bianco pieno */
}

/* PRICE */
.product-price {
  font-size:15px; font-weight:700;
  color:rgba(255,255,255,0.85);   /* quasi bianco, ben leggibile */
  text-align:right; white-space:nowrap;
}

/* ===== INPUTS ===== */
.inputs-section { margin-top:28px; }

.input-group { margin-bottom:12px; position:relative; }

.input-group .input-icon {
  position:absolute; left:16px; top:50%; transform:translateY(-50%);
  color:rgba(255,255,255,0.3); font-size:14px; pointer-events:none;
}

.input-group input {
  width:100%;
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:12px; padding:14px 16px 14px 42px;
  font-size:14px; font-weight:600; font-family:'Montserrat',sans-serif;
  color:white;    /* testo bianco mentre scrivi */
  outline:none; transition:all 0.25s ease;
}
.input-group input.no-icon { padding-left:16px; }
.input-group input::placeholder { color:rgba(255,255,255,0.35); font-weight:400; }
.input-group input:focus { border-color:rgba(230,57,70,0.55); background:rgba(255,255,255,0.09); }

.input-error { border-color:#e63946 !important; animation:shake 0.3s; }
@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 50%{transform:translateX(5px)} 75%{transform:translateX(-5px)} 100%{transform:translateX(0)} }

/* ===== TOTAL BAR ===== */
.total-bar {
  width:100%; max-width:580px;
  background:rgba(10,3,3,0.92);
  backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,0.1);
  border-top:1px solid rgba(230,57,70,0.25);
  border-radius:0 0 20px 20px;
  padding:18px 24px;
  display:flex; align-items:center; justify-content:space-between; gap:16px;
  margin-top:-1px;
  box-shadow:0 14px 44px rgba(0,0,0,0.5);
}

.clear-btn {
  width:44px; height:44px; border-radius:10px;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
  display:flex; justify-content:center; align-items:center;
  cursor:pointer; transition:all 0.25s ease; flex-shrink:0;
}
.clear-btn:hover { background:rgba(230,57,70,0.18); border-color:rgba(230,57,70,0.45); }
.clear-btn svg { stroke:rgba(255,255,255,0.55); }
.clear-btn:hover svg { stroke:#ff9090; }

.total-price {
  font-size:28px; font-weight:800;
  color:white;   /* bianco pieno — ben visibile */
  letter-spacing:1px; flex:1; text-align:center;
}

.checkout-btn {
  background:linear-gradient(135deg,#b22222,#e63946);
  color:white; border:none; padding:14px 32px;
  font-size:14px; font-weight:800; letter-spacing:2px; text-transform:uppercase;
  border-radius:12px; cursor:pointer; transition:all 0.3s ease;
  box-shadow:0 4px 20px rgba(230,57,70,0.45); white-space:nowrap; flex-shrink:0;
  font-family:'Montserrat',sans-serif;
}
.checkout-btn:hover { transform:translateY(-3px); box-shadow:0 10px 28px rgba(230,57,70,0.6); }

/* ===== OVERLAY ===== */
.overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); opacity:0; display:none; transition:opacity 0.3s ease; z-index:200; }
.overlay.active { display:block; opacity:1; }

/* ===== POPUP NOTE ===== */
#popup-ingredienti {
  width:360px;
  background:rgba(12,4,4,0.97); backdrop-filter:blur(20px);
  border:1px solid rgba(230,57,70,0.2); border-radius:20px;
  padding:28px 24px 22px;
  display:none; flex-direction:column; gap:14px;
  color:white; position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%) scale(0.88);
  transition:transform 0.25s ease, opacity 0.25s ease;
  z-index:300; opacity:0;
  box-shadow:0 24px 60px rgba(0,0,0,0.75);
}
#popup-ingredienti.active { display:flex; transform:translate(-50%,-50%) scale(1); opacity:1; }
#popup-ingredienti h2 { font-size:14px; font-weight:800; letter-spacing:3px; text-transform:uppercase; color:white; text-align:center; margin:0; }

.ingredient-row {
  padding:11px 16px;
  background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.1);
  border-radius:10px; font-size:14px; font-weight:600; color:white;  /* bianco pieno */
}

.popup-close-btn {
  width:100%; padding:13px;
  background:rgba(230,57,70,0.12); border:1px solid rgba(230,57,70,0.3);
  border-radius:12px; color:#ff8080; font-weight:800; font-size:12px;
  letter-spacing:2px; text-transform:uppercase; cursor:pointer;
  transition:all 0.25s ease; font-family:'Montserrat',sans-serif; margin-top:2px;
}
.popup-close-btn:hover { background:rgba(230,57,70,0.25); color:white; }

/* ===== SUCCESS POPUP ===== */
#success-popup {
  position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%) scale(0.82);
  width:360px;
  background:linear-gradient(145deg,#8B0000,#e63946);
  border:none; border-radius:20px; padding:40px 30px;
  text-align:center; display:none; flex-direction:column; align-items:center; gap:16px;
  z-index:400; box-shadow:0 24px 60px rgba(230,57,70,0.55);
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s ease;
  opacity:0; font-family:'Montserrat',sans-serif;
}
#success-popup.active { display:flex; transform:translate(-50%,-50%) scale(1); opacity:1; }
#success-popup .icon-circle { width:66px; height:66px; border-radius:50%; background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3); display:flex; justify-content:center; align-items:center; }
#success-popup .icon-circle svg { width:32px; height:32px; stroke:white; }
#success-popup h2 { font-size:22px; font-weight:800; color:white; margin:0; }
#success-popup p { font-size:14px; font-weight:500; color:rgba(255,255,255,0.85); margin:0; line-height:1.65; }
#success-close { position:absolute; top:12px; right:12px; cursor:pointer; font-weight:900; font-size:14px; color:white; background:rgba(0,0,0,0.2); border:none; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; transition:0.3s; }
#success-close:hover { background:rgba(255,255,255,0.2); }

/* ===== ERROR BOX ===== */
#error-box {
  position:fixed; top:-120px; left:50%; transform:translateX(-50%);
  background:linear-gradient(145deg,#8B0000,#e63946);
  padding:22px 46px 22px 22px; border-radius:14px;
  box-shadow:0 8px 30px rgba(230,57,70,0.55);
  color:white; font-family:'Montserrat',sans-serif;
  width:360px; max-width:92%;
  transition:top 0.5s ease, opacity 0.5s ease;
  z-index:99999; opacity:0;
  display:flex; flex-direction:column; align-items:flex-start; gap:8px;
}
#error-box.show { top:24px; opacity:1; }
#error-box strong { font-size:17px; font-weight:800; color:white; }
#error-box p { margin:0; line-height:1.35; font-size:14px; color:rgba(255,255,255,0.9); font-weight:500; }
#error-box .confirm-btn { margin-top:6px; width:100%; padding:12px; border-radius:10px; background:white; color:#8B0000; border:none; font-weight:800; font-family:'Montserrat',sans-serif; cursor:pointer; transition:0.3s; font-size:13px; letter-spacing:1px; }
#error-box .confirm-btn:hover { background:rgba(255,255,255,0.88); }
#error-box .close-btn { position:absolute; top:10px; right:10px; cursor:pointer; font-weight:900; font-size:18px; color:white; background:rgba(0,0,0,0.18); border:none; border-radius:50%; width:26px; height:26px; display:flex; align-items:center; justify-content:center; transition:0.3s; }
#error-box .close-btn:hover { background:rgba(255,255,255,0.25); }

/* ===== RESPONSIVE ===== */
@media (max-width:768px) {
  .navbar { height:80px; padding:0 20px; }
  .logo-left { left:20px; }
  .logo-left img { width:48px; height:48px; }
  .logo-brand .brand-sub { display:none; }
  .logo-brand .brand-main { font-size:12px; }
  .nav-center { display:none; }
  .nav-center.active { display:block; position:absolute; top:80px; left:0; width:100%; background:rgba(6,2,2,0.99); border-bottom:1px solid rgba(230,57,70,0.12); }
  .nav-center.active ul { flex-direction:column; }
  .nav-center.active a { padding:14px 24px; border-bottom:1px solid rgba(255,255,255,0.05); }
  .social-icons { display:none; }
  .menu-toggle { display:block; }
  .page-wrapper { padding-top:100px; padding-left:14px; padding-right:14px; }
  .main-card { padding:22px 18px; }
  .total-bar { padding:14px 18px; }
  .page-header h1 { font-size:32px; }
}
@media (max-width:480px) {
  .navbar { height:70px; }
  .page-header h1 { font-size:26px; }
  .main-card,.total-bar { border-radius:16px; }
  .total-bar { border-radius:0 0 16px 16px; }
  .total-price { font-size:23px; }
  .checkout-btn { padding:12px 20px; font-size:13px; }
  .product-card { gap:10px; }
  .products-header { gap:10px; }
}

.info-input::placeholder { color:var(--placeholder-color, rgba(255,255,255,0.35)); }
</style>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar" id="navbar">
  <div class="logo-left">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
    <div class="logo-left-divider"></div>
    <div class="logo-brand">
      <span class="brand-sub">Sala &amp; Bar</span>
      <span class="brand-main">Scuola Borsa</span>
    </div>
  </div>
  <button class="menu-toggle" id="menu-toggle">☰</button>
  <nav class="nav-center" id="nav-center">
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/#chi-siamo">Chi siamo</a></li>
      <li><a href="/#gallery">Galleria</a></li>
      <li><a href="/#contatti">Contatti</a></li>
      <li><a id="login-btn">Login</a></li>
    </ul>
  </nav>
  <div class="social-icons">
    <a href="https://www.facebook.com/aziendaspecialediformazionescuolapaoloborsa/"><i class="fab fa-facebook-f"></i></a>
    <a href="https://www.instagram.com/scuola_borsa/"><i class="fab fa-instagram"></i></a>
    <a href="https://www.youtube.com/@ScuolaPaoloBorsaMonza"><i class="fab fa-youtube"></i></a>
  </div>
</header>

<form action="{{url_for('orders.new_order')}}" method="POST">
<div class="page-wrapper">

  <div class="page-header">
    <h1>Il tuo Ordine</h1>
    <div class="accent-line"></div>
  </div>

  <div class="main-card">

    <!-- PRODOTTI -->
    <span class="section-label">Prodotti selezionati</span>
    <div class="red-divider"></div>

    <div class="products-header">
      <span>Prodotto</span>
      <span class="h-qty">Quantità</span>
      <span class="h-price">Prezzo</span>
    </div>

    <div id="product-container"></div>
    <input type="hidden" id="prodottiSelezionati" name="prodottiSelezionati">

    <!-- NOTE + INFO -->
    <div class="inputs-section">

      <span class="section-label" style="margin-top:26px; display:block;">Note generali</span>
      <div class="red-divider"></div>
      <div class="input-group">
        <i class="input-icon fas fa-sticky-note"></i>
        <input id="noteGenerali" type="text" class="note-input" placeholder="Aggiungi una nota..." list="lista-note-generali" name="noteGenerali"/>
        <datalist id="lista-note-generali">
          {% for gruppo in general_notes %}
            {% for nota in gruppo.note %}
              <option value="{{ nota.nome }}">
            {% endfor %}
          {% endfor %}
        </datalist>
      </div>

      <span class="section-label" style="margin-top:22px; display:block;">Informazioni</span>
      <div class="red-divider"></div>
      <div class="input-group">
        <i class="input-icon fas fa-user"></i>
        <input id="nome" type="text" class="info-input" placeholder="Nome" name="nome"/>
      </div>
      <div class="input-group">
        <i class="input-icon fas fa-user"></i>
        <input id="cognome" type="text" class="info-input" placeholder="Cognome" name="cognome"/>
      </div>
      <div class="input-group">
        <i class="input-icon fas fa-graduation-cap"></i>
        <input id="classe" type="text" class="info-input" placeholder="Classe" list="lista-classi" name="classe"/>
        <datalist id="lista-classi">
          {% for c in listClass %}
            <option value="{{ c.nome }}">
          {% endfor %}
        </datalist>
      </div>
    </div>

    <input type="hidden" id="totalInput" name="total" value="0">
  </div>

  <!-- TOTAL BAR -->
  <div class="total-bar">
    <button id="clearCartBtn" class="clear-btn" type="button" title="Svuota ordine">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
        <path d="M10 11v6"></path><path d="M14 11v6"></path>
        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
      </svg>
    </button>
    <div class="total-price" id="total">€0,00</div>
    <button class="checkout-btn" id="invia" type="button">INVIA</button>
  </div>

</div>
</form>

<!-- OVERLAY -->
<div class="overlay" id="overlay"></div>

<!-- POPUP NOTE -->
<div id="popup-ingredienti">
  <h2>Note Prodotto</h2>
  <div class="red-divider" style="margin-bottom:4px;"></div>
  <div id="ingredient-container"></div>
  <button class="popup-close-btn" id="back" type="button">Chiudi</button>
</div>

<!-- SUCCESS POPUP -->
<div id="success-popup">
  <button type="button" id="success-close">✕</button>
  <div class="icon-circle">
    <svg fill="none" stroke-width="2.5" stroke="white" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <path d="M20 6L9 17l-5-5"></path>
    </svg>
  </div>
  <h2>Ordine confermato!</h2>
  <p>Grazie per aver ordinato da noi.<br>Il tuo ordine sarà pronto al più presto.</p>
</div>

<!-- ERROR BOX (svuota carrello) -->
<div id="error-box">
  <strong>Attenzione!</strong>
  <p>Vuoi cancellare tutti gli ordini?</p>
  <button class="confirm-btn">SÌ, SVUOTA</button>
  <button type="button" class="close-btn">&times;</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let ordineInviato = false;
  let products = JSON.parse(localStorage.getItem("orderedItems")) || [];
  products = products.filter(p => p.name && !isNaN(p.price));

  const productContainer = document.getElementById("product-container");
  const totalPriceEl = document.getElementById("total");

  // Mobile nav
  const menuToggle = document.getElementById('menu-toggle');
  const navCenter = document.getElementById('nav-center');
  if (menuToggle) {
    menuToggle.addEventListener('click', () => navCenter.classList.toggle('active'));
    document.querySelectorAll('.nav-center a').forEach(l => l.addEventListener('click', () => navCenter.classList.remove('active')));
  }

  function saveOrderedItems() {
    localStorage.setItem("orderedItems", JSON.stringify(products));
    window.orderedProducts = products;
    updateHiddenInput();
  }

  function updateHiddenInput() {
    try { document.getElementById("prodottiSelezionati").value = JSON.stringify(products); }
    catch(e) { document.getElementById("prodottiSelezionati").value = ""; }
  }

  window.orderedProducts = products;

  const ingredientiProdotto = {
    "Focaccia": ["Pane","Pomodoro","Mozzarella"],
    "Cup Cake": ["Farina","Zucchero","Burro","Uova","Vaniglia"],
    "Pizzette": ["Pomodoro","Mozzarella","Basilico"],
    "Panino": ["Pane","Prosciutto","Formaggio","Insalata"],
  };

  products.forEach(prod => {
    if (!prod.ingredients || prod.ingredients.length === 0) {
      prod.ingredients = ingredientiProdotto[prod.name] || [`${prod.name} Base`, "Sale", "Olio"];
      prod.extra = prod.extra || [];
      prod.allergeni = prod.allergeni || [];
    }
  });

  saveOrderedItems();

  let currentProductIndex = null;

  /* RENDER */
  function renderProducts() {
    productContainer.innerHTML = "";
    let total = 0;

    products.forEach((p, i) => {
      const row = document.createElement("div");
      row.className = "product-card";
      row.innerHTML = `
        <div class="product-name">
          <button class="note-btn" type="button" data-index="${i}" title="Note prodotto">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"/>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
            </svg>
          </button>
          <span>${p.name}</span>
        </div>
        <div class="qty-column">
          <div class="qty-box">
            <button class="qty-btn" data-index="${i}" data-action="minus">−</button>
            <span class="qty">${p.qty || 1}</span>
            <button class="qty-btn" data-index="${i}" data-action="plus">+</button>
          </div>
        </div>
        <div class="product-price">€${(p.price*(p.qty||1)).toLocaleString('it-IT',{minimumFractionDigits:0,maximumFractionDigits:2})}</div>
      `;
      productContainer.appendChild(row);
      total += p.price * (p.qty || 1);
    });

    totalPriceEl.textContent = `€${total.toLocaleString('it-IT',{minimumFractionDigits:0,maximumFractionDigits:2})}`;
    updateHiddenInput();
  }

  /* CLICKS */
  productContainer.addEventListener("click", function(e) {
    if (e.target.classList.contains("qty-btn")) {
      const i = e.target.dataset.index;
      const a = e.target.dataset.action;
      if (a === "plus") { if ((products[i].qty||1) < 10) products[i].qty = (products[i].qty||1)+1; }
      else products[i].qty = Math.max(1, (products[i].qty||1)-1);
      saveOrderedItems(); renderProducts(); return;
    }
    const nb = e.target.closest(".note-btn");
    if (nb) { currentProductIndex = nb.dataset.index; showPopupIngredienti(); }
  });

  /* POPUP NOTE */
  const overlay = document.getElementById("overlay");
  const popupIngredienti = document.getElementById("popup-ingredienti");
  const ingredientContainer = document.getElementById("ingredient-container");

  document.getElementById("back").addEventListener("click", () => {
    popupIngredienti.classList.remove("active");
    overlay.classList.remove("active");
  });

  function showPopupIngredienti() {
    ingredientContainer.innerHTML = "";
    const prod = products[currentProductIndex];
    prod.ingredients.forEach(ing => {
      const row = document.createElement("div");
      row.className = "ingredient-row";
      row.textContent = ing;
      ingredientContainer.appendChild(row);
    });
    popupIngredienti.classList.add("active");
    overlay.classList.add("active");
  }

  /* INVIO */
  const btnInvia = document.getElementById("invia");
  const nomeInput = document.getElementById("nome");
  const cognomeInput = document.getElementById("cognome");
  const classeInput = document.getElementById("classe");
  const successPopup = document.getElementById("success-popup");

  btnInvia.addEventListener("click", () => {
    let valid = true;

    function checkName(input, label) {
      input.classList.remove("input-error");
      if (!/^[A-Za-zÀ-ÖØ-öø-ÿ]{3,}$/.test(input.value.trim())) {
        valid = false; input.classList.add("input-error"); input.value = "";
        input.placeholder = `⚠ Scrivi il ${label}`; input.style.setProperty("--placeholder-color","#e63946");
      }
    }

    function checkClasse(input) {
      const opzioni = Array.from(document.querySelectorAll("#lista-classi option")).map(o => o.value);
      if (!opzioni.includes(input.value.trim())) {
        input.classList.add("input-error"); input.value = "";
        input.placeholder = "⚠ Scrivi la classe"; input.style.setProperty("--placeholder-color","#e63946"); return false;
      }
      return true;
    }

    checkName(nomeInput,"nome"); checkName(cognomeInput,"cognome");
    if (!checkClasse(classeInput)) valid = false;
    if (!valid) { nomeInput.scrollIntoView({behavior:"smooth",block:"center"}); return; }
    if (!products.length) { alert("Devi ordinare almeno un prodotto!"); return; }

    updateHiddenInput();
    if (ordineInviato) return;
    ordineInviato = true;
    successPopup.classList.add("active");
    overlay.classList.add("active");
    document.getElementById("totalInput").value = document.getElementById("total").textContent;
    setTimeout(() => document.querySelector("form").submit(), 3000);
  });

  /* CHIUDI SUCCESS */
  document.getElementById("success-close").addEventListener("click", () => {
    successPopup.classList.remove("active");
    overlay.classList.remove("active");
    localStorage.removeItem("orderedItems");
    products = []; renderProducts();
    ["nome","cognome","classe","noteGenerali"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("total").textContent = "€0,00";
    document.getElementById("totalInput").value = "0";
  });

  /* SVUOTA */
  const errorBox = document.getElementById("error-box");
  document.getElementById("clearCartBtn").addEventListener("click", () => errorBox.classList.add("show"));
  errorBox.querySelector(".close-btn").addEventListener("click", () => errorBox.classList.remove("show"));
  errorBox.querySelector(".confirm-btn").addEventListener("click", () => { localStorage.removeItem("orderedItems"); location.reload(); });

  renderProducts();
});
</script>
</body>
</html>